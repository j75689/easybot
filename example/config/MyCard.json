{
  "id": "MyCard",
  "eventType": "message",
  "messageType": "text",
  "match": ["我的行動借閱證"],
  "timeout": 120,
  "defaultValues": {
    "baseUrl": "https://rwdpac.cultural.pthg.gov.tw"
  },
  "stage": [
    {
      "type": "action",
      "plugin": "Graphql",
      "parameter": {
        "apiURL": "http://hylibservice:8080/graphql",
        "query": "query checkLine($lineID:String){checkLineIDUser(lineID:$lineID){success message debuglog}}",
        "variables": {
          "lineID": "${source.UserID}"
        },
        "output": {
          "isLineUser": "checkLineIDUser.success",
          "debuglog": "checkLineIDUser.debuglog"
        }
      }
    },
    {
      "type": "action",
      "plugin": "Equal",
      "parameter": {
        "target": "${isLineUser}",
        "value": "true"
      },
      "failed": [
        {
          "type": "reply",
          "value": {
            "type": "flex",
            "altText": "綁定LINE個人化服務 同意書",
            "contents": {
              "type": "bubble",
              "direction": "ltr",
              "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "綁定LINE個人化服務 同意書",
                    "size": "lg",
                    "align": "center"
                  }
                ]
              },
              "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "本服務所提供的個人資訊，僅作為個人書房與行動借閱證認證使用，不會轉為其他用途。LINE與好友間的對話已經過點對點加密(Letter Sealing)，即便是LINE公司也無法看到「對話內容」，更不會因為您同意隱私權政策的更新而被以任何形式運用。",
                    "align": "start",
                    "wrap": true
                  }
                ]
              },
              "footer": {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                      {
                        "type": "button",
                        "action": {
                          "type": "message",
                          "label": "不同意",
                          "text": "感謝您的使用，您仍可使用館藏查詢、新書、展示書等服務，若未來要使用借閱證或個人書房功能，請再點擊圖文選單相對應按鈕。"
                        }
                      },
                      {
                        "type": "button",
                        "action": {
                          "type": "uri",
                          "label": "同意",
                          "uri": "${baseUrl}/line/linkAccount?lineId=${source.UserID}"
                        }
                      }
                    ]
                  }
                ]
              }
            }
          }
        }
      ]
    },
    {
      "type": "action",
      "plugin": "Graphql",
      "parameter": {
        "apiURL": "http://hylibservice:8080/graphql",
        "query": "query openDigCard($lineID:String,$force:Boolean){getDigitalCard(lineID:$lineID,force:$force){cardurl dateline name idlicense}}",
        "variables": {
          "lineID": "${source.UserID}",
          "force": false
        },
        "output": {
          "cardurl": "getDigitalCard.cardurl",
          "dateline": "getDigitalCard.dateline",
          "name": "getDigitalCard.name",
          "idlicense": "getDigitalCard.idlicense"
        }
      }
    },
    {
      "type": "reply",
      "value": {
        "type": "flex",
        "altText": "行動借閱證",
        "contents": {
          "type": "bubble",
          "body": {
            "type": "box",
            "layout": "vertical",
            "spacing": "md",
            "contents": [
              {
                "type": "text",
                "text": "行動借閱證",
                "size": "xl",
                "align": "center",
                "gravity": "center",
                "weight": "bold",
                "wrap": true
              },
              {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "margin": "lg",
                "contents": [
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "期限",
                        "flex": 1,
                        "size": "sm",
                        "color": "#AAAAAA"
                      },
                      {
                        "type": "text",
                        "text": "${dateline}",
                        "flex": 4,
                        "size": "sm",
                        "weight": "regular",
                        "color": "#666666",
                        "wrap": true
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "姓名",
                        "flex": 1,
                        "size": "sm",
                        "color": "#AAAAAA"
                      },
                      {
                        "type": "text",
                        "text": "${name}",
                        "flex": 4,
                        "size": "sm",
                        "align": "start",
                        "weight": "regular",
                        "color": "#666666",
                        "wrap": true
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "baseline",
                    "spacing": "sm",
                    "contents": [
                      {
                        "type": "text",
                        "text": "身分證",
                        "flex": 1,
                        "size": "sm",
                        "color": "#AAAAAA"
                      },
                      {
                        "type": "text",
                        "text": "${idlicense}",
                        "flex": 4,
                        "size": "sm",
                        "align": "start",
                        "weight": "regular",
                        "color": "#666666",
                        "wrap": true
                      }
                    ]
                  },
                  {
                    "type": "box",
                    "layout": "vertical",
                    "margin": "xxl",
                    "contents": [
                      {
                        "type": "spacer"
                      },
                      {
                        "type": "image",
                        "url": "https://rwdpac.cultural.pthg.gov.tw/api/HyLibWS/personalCard/${cardurl}",
                        "align": "center",
                        "gravity": "center",
                        "size": "5xl",
                        "aspectRatio": "16:9",
                        "aspectMode": "fit"
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "footer": {
            "type": "box",
            "layout": "horizontal",
            "flex": 1,
            "contents": [
              {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "button",
                    "action": {
                      "type": "uri",
                      "label": "顯示更多",
                      "uri": "${baseUrl}/line/digitalcard?code=${##URL##:cardurl}"
                    },
                    "height": "sm"
                  }
                ]
              }
            ]
          }
        }
      }
    }
  ]
}
